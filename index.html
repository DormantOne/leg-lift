<!DOCTYPE html>
<html>
<head>
  <title>Leg Lift Test</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
</head>
<body>

  <!-- Test Form -->
  <form id="testForm">
    <input type="text" id="roomNumber" name="roomNumber" placeholder="Room Number" required>
    <fieldset>
      <legend>Left Leg Strength</legend>
      <label><input type="radio" name="leftLeg" value="3"> Raises against resistance and can sustain</label>
      <label><input type="radio" name="leftLeg" value="2"> Can raise leg off bed but gives immediately with resistance</label>
      <label><input type="radio" name="leftLeg" value="1"> Cannot get heel off bed but bends knee</label>
      <label><input type="radio" name="leftLeg" value="0"> Cannot bend knee or get heel off bed</label>
    </fieldset>
    <fieldset>
      <legend>Right Leg Strength</legend>
      <label><input type="radio" name="rightLeg" value="3"> Raises against resistance and can sustain</label>
      <label><input type="radio" name="rightLeg" value="2"> Can raise leg off bed but gives immediately with resistance</label>
      <label><input type="radio" name="rightLeg" value="1"> Cannot get heel off bed but bends knee</label>
      <label><input type="radio" name="rightLeg" value="0"> Cannot bend knee or get heel off bed</label>
    </fieldset>
    <input type="submit" value="Submit">
  </form>

  <!-- Outcome Section -->
  <div id="outcomesSection">
    <h2>Outcomes</h2>
    <!-- Outcomes will be populated here -->
  </div>

  <!-- Data Display -->
  <div id="dataDisplay">
    <h2>Stored Data</h2>
    <ul id="dataList"></ul>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCCY8_z-0C0RCQUp9brvM0hFMd7VsrjSXo",
      authDomain: "leg-lift.firebaseapp.com",
      projectId: "leg-lift",
      storageBucket: "leg-lift.appspot.com",
      messagingSenderId: "973223228733",
      appId: "1:973223228733:web:be43c16653cac99fe90154",
      measurementId: "G-0YK2ZTNCVX"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let outcomesListener = null;
let testsListener = null;  // Add this

     // ★ Initialize once when the page loads
    function init() {
      // ★ Attach listeners here
      db.collection('tests').onSnapshot((testSnapshot) => {
        // Clear previous entries
        document.getElementById('dataList').innerHTML = '';
        testSnapshot.forEach((testDoc) => {
          displayTestData(testDoc);
        });
      });

      // ★ Attach new listener for 'outcomes' 
      db.collection('outcomes').onSnapshot((querySnapshot) => {
        // Clear previous entries in outcomes section
        document.getElementById('outcomesSection').innerHTML = '<h2>Outcomes</h2>';
        querySnapshot.forEach((doc) => {
          createOutcomeDiv(doc.data().room, doc.data().date, doc.data().testId, doc.id);
        });
      });
    }

    // ★ Call this function when the page loads
    window.addEventListener('load', (event) => {
      init();
    });
    
    document.getElementById('testForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const roomNumber = document.getElementById('roomNumber').value;
      const leftLegStrength = document.querySelector('input[name="leftLeg"]:checked').value;
      const rightLegStrength = document.querySelector('input[name="rightLeg"]:checked').value;
      db.collection('tests').add({
        date: new Date().toISOString().split('T')[0],
        room: roomNumber,
        leftLegStrength: leftLegStrength,
        rightLegStrength: rightLegStrength
     }).then(() => {
        populateOutcomesSection();  // Trigger after a new test is added
      });
      // Reset the form fields
      e.target.reset();
    });



// Function to display test data along with the associated outcome
function displayTestData(doc) {
  let li = document.createElement('li');
  const room = doc.data().room;
  const date = doc.data().date;
  const testDocId = doc.id;  // Assume doc.id contains the document ID of the test

  // Fetch the associated outcome based on the room
  db.collection('outcomes').where('room', '==', room).get().then((outcomeSnapshot) => {
    let outcomeText = 'Not Yet Answered'; // Default value if no outcome is found
    let outcomeDocId = null;  // To store the document ID of the outcome

    if (!outcomeSnapshot.empty) {
      outcomeSnapshot.forEach((outcomeDoc) => {
        outcomeText = outcomeDoc.data().outcome;
        outcomeDocId = outcomeDoc.id;  // Store the document ID
      });
    } else {
      // If no outcome exists, create a default one
      db.collection('outcomes').add({
        date: date,  // You can adjust this
        room: room,
        outcome: 'Not Yet Answered',
        testId: testDocId  // Link it to the test
      }).then((docRef) => {
        outcomeDocId = docRef.id;  // Store the newly created document ID
      }).catch((error) => {
        console.error("Error adding default outcome: ", error);
      });
    }

    // Now append the outcome to the list item text
    li.textContent = `Test Data: Date: ${date}, Room: ${room}, Left Leg Strength: ${doc.data().leftLegStrength}, Right Leg Strength: ${doc.data().rightLegStrength}, Outcome: ${outcomeText}`;
    document.getElementById('dataList').appendChild(li);

    // If you want, you can also create UI elements to update the outcome here,
    // using the outcomeDocId and testDocId
  });
}





function displayOutcomeData(doc) {
  console.log("Modifying DOM to display outcomes");  // Debugging line
  let li = document.createElement('li');
  li.textContent = `Outcome Data: ID: ${doc.id}, Date: ${doc.data().date}, Room: ${doc.data().room}, Outcome: ${doc.data().outcome}`;
  document.getElementById('dataList').appendChild(li);
}





function createOutcomeDiv(room, date, testDocId, outcomeDocId = null) {
  console.log("createOutcomeDiv called with outcomeDocId:", outcomeDocId);  // Debugging line
  
  let div = document.createElement('div');
  div.innerHTML = `
    <span>Room: ${room}, Test Date: ${date}</span>
    <input type="radio" name="outcome-${room}" value="Not Yet Answered" checked> Not Yet Answered
    <input type="radio" name="outcome-${room}" value="Walk"> Walk
    <input type="radio" name="outcome-${room}" value="Not Walked"> Not Walked
    <button onclick="submitOutcome('${room}', '${outcomeDocId}', '${testDocId}')">Submit Outcome</button>
    <button onclick="deleteTest('${testDocId}', '${room}')">Delete from Database</button>
  `;
  document.getElementById('outcomesSection').appendChild(div);
}

// Updated Submit Outcome Function
function submitOutcome(room, outcomeDocId, testDocId) {  // Add 'testDocId' as a new parameter
  const outcome = document.querySelector(`input[name="outcome-${room}"]:checked`).value;
  if (outcomeDocId && outcomeDocId !== 'null') {
    db.collection('outcomes').doc(outcomeDocId).update({
      date: new Date().toISOString().split('T')[0],
      outcome: outcome,
      testId: testDocId  // Add this line
    }).then(() => {
      // Only delete the outcome if it's reset to "Not Yet Answered"
      if (outcome === "Not Yet Answered") {
        db.collection('outcomes').doc(outcomeDocId).delete();
      }
      populateOutcomesSection();  // This line can be removed if you are using listeners
    }).catch((error) => {
      console.error("Error updating document: ", error);
    });
  } else {
    db.collection('outcomes').add({
      date: new Date().toISOString().split('T')[0],
      room: room,
      outcome: outcome,
      testId: testDocId  // Add this line
    }).then(() => {
      populateOutcomesSection();  // This line can be removed if you are using listeners
    }).catch((error) => {
      console.error("Error adding document: ", error);
    });
  }
}


// Updated deleteTest function
function deleteTest(testDocId, room) {  // Pass room as an argument
  db.collection('tests').doc(testDocId).delete().then(() => {
    db.collection('outcomes').where('room', '==', room).get().then((querySnapshot) => {
      querySnapshot.forEach((doc) => {
        doc.ref.delete();
      });
    });
    populateOutcomesSection();  // Refresh outcomes section
  });
}


  

  </script>
</body>
</html>
