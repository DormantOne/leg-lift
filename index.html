<!DOCTYPE html>
<html>
<head>
  <title>Leg Lift Test</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
</head>
<body>

  <!-- Test Form -->
  <form id="testForm">
    <input type="text" id="roomNumber" name="roomNumber" placeholder="Room Number" required>
    <fieldset>
      <legend>Left Leg Strength</legend>
      <label><input type="radio" name="leftLeg" value="3"> Raises against resistance and can sustain</label>
      <label><input type="radio" name="leftLeg" value="2"> Can raise leg off bed but gives immediately with resistance</label>
      <label><input type="radio" name="leftLeg" value="1"> Cannot get heel off bed but bends knee</label>
      <label><input type="radio" name="leftLeg" value="0"> Cannot bend knee or get heel off bed</label>
    </fieldset>
    <fieldset>
      <legend>Right Leg Strength</legend>
      <label><input type="radio" name="rightLeg" value="3"> Raises against resistance and can sustain</label>
      <label><input type="radio" name="rightLeg" value="2"> Can raise leg off bed but gives immediately with resistance</label>
      <label><input type="radio" name="rightLeg" value="1"> Cannot get heel off bed but bends knee</label>
      <label><input type="radio" name="rightLeg" value="0"> Cannot bend knee or get heel off bed</label>
    </fieldset>
    <input type="submit" value="Submit">
  </form>

  <!-- Outcome Section -->
  <div id="outcomesSection">
    <h2>Outcomes</h2>
    <!-- Outcomes will be populated here -->
  </div>

  <!-- Data Display -->
  <div id="dataDisplay">
    <h2>Stored Data</h2>
    <ul id="dataList"></ul>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCCY8_z-0C0RCQUp9brvM0hFMd7VsrjSXo",
      authDomain: "leg-lift.firebaseapp.com",
      projectId: "leg-lift",
      storageBucket: "leg-lift.appspot.com",
      messagingSenderId: "973223228733",
      appId: "1:973223228733:web:be43c16653cac99fe90154",
      measurementId: "G-0YK2ZTNCVX"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

document.getElementById('testForm').addEventListener('submit', function(e) {
  e.preventDefault();
  if (!document.querySelector('input[name="leftLeg"]:checked') || !document.querySelector('input[name="rightLeg"]:checked')) {
  alert("Please select strength values for both legs.");
  return;
}

  const roomNumber = document.getElementById('roomNumber').value;
  const leftLegStrength = document.querySelector('input[name="leftLeg"]:checked').value;
  const rightLegStrength = document.querySelector('input[name="rightLeg"]:checked').value;
  
  // Capture Timestamp
  const testTimestamp = new Date().toISOString();
  const testDate = testTimestamp.split('T')[0];

  // First, check if a test for the same room and date already exists
  db.collection('tests').where('room', '==', roomNumber).where('date', '==', testDate).get().then((querySnapshot) => {
    // If such a test exists, delete it
    if (!querySnapshot.empty) {
      querySnapshot.forEach((doc) => {
        doc.ref.delete();
      });
    }
    // Add the new test data
    return db.collection('tests').add({
      date: testDate,
      time: testTimestamp.split('T')[1].split('.')[0], // Time without milliseconds
      room: roomNumber,
      leftLegStrength: leftLegStrength,
      rightLegStrength: rightLegStrength
    });
  }).then((docRef) => {
    populateOutcomesSection(docRef.id, testTimestamp, leftLegStrength, rightLegStrength); // Pass new variables
  }).catch((error) => {
    console.error("Error handling test data: ", error);
  });
});




    function displayTestData(doc) {
      let li = document.createElement('li');
      li.textContent = `Test Data: Date: ${doc.data().date}, Room: ${doc.data().room}, Left Leg Strength: ${doc.data().leftLegStrength}, Right Leg Strength: ${doc.data().rightLegStrength}`;
      document.getElementById('dataList').appendChild(li);
    }

function displayOutcomeData(doc) {
  let li = document.createElement('li');
  li.textContent = `Outcome Data: ID: ${doc.id}, Date: ${doc.data().date}, Room: ${doc.data().room}, Outcome: ${doc.data().outcome}`;
  document.getElementById('dataList').appendChild(li);
}


    db.collection('outcomes').onSnapshot((querySnapshot) => {
      querySnapshot.forEach((doc) => {
        displayOutcomeData(doc);
      });
    });


function populateOutcomesSection(testDocId = null, testTimestamp = null, leftLegStrength = null, rightLegStrength = null) {
  document.getElementById('outcomesSection').innerHTML = "<h2>Outcomes</h2>";  // Clear previous entries
  db.collection('tests').get().then((testSnapshot) => {
    testSnapshot.forEach((testDoc) => {
      const room = testDoc.data().room;
      const date = testDoc.data().date;
      db.collection('outcomes').where('room', '==', room).get().then((outcomeSnapshot) => {
        if (outcomeSnapshot.empty) {
          createOutcomeDiv(room, date, testDoc.id, null, testTimestamp, leftLegStrength, rightLegStrength);  // Pass new variables
        } else {
          outcomeSnapshot.forEach((outcomeDoc) => {
            if (outcomeDoc.data().outcome === "Not Yet Answered") {
              createOutcomeDiv(room, date, testDoc.id, outcomeDoc.id, testTimestamp, leftLegStrength, rightLegStrength);  // Pass new variables
            }
          });
        }
      });
    });
  });
}


function createOutcomeDiv(room, date, testDocId, outcomeDocId = null, testTimestamp = null, leftLegStrength = null, rightLegStrength = null) {
  console.log("createOutcomeDiv called with outcomeDocId:", outcomeDocId);  // Debugging line
  
  let div = document.createElement('div');
  div.innerHTML = `
    <span>Room: ${room}, Test Date: ${date}</span>
    <input type="radio" name="outcome-${room}" value="Not Yet Answered" checked> Not Yet Answered
    <input type="radio" name="outcome-${room}" value="Walk"> Walk
    <input type="radio" name="outcome-${room}" value="Not Walked"> Not Walked
    <button onclick="submitOutcome('${room}', '${outcomeDocId}', '${testDocId}', '${testTimestamp}', ${leftLegStrength}, ${rightLegStrength})">Submit Outcome</button>
    <button onclick="deleteTest('${testDocId}', '${room}')">Delete from Database</button>
  `;
  document.getElementById('outcomesSection').appendChild(div);
}



function submitOutcome(room, outcomeDocId, testDocId = null, testTimestamp = null, leftLegStrength = null, rightLegStrength = null) {
  console.log("submitOutcome called with outcomeDocId:", outcomeDocId);  // Debugging line

  const outcomeTimestamp = new Date().toISOString();
  const outcome = document.querySelector(`input[name="outcome-${room}"]:checked`).value;

  // Define the outcome data
  const outcomeData = {
    date: outcomeTimestamp.split('T')[0],
    time: outcomeTimestamp.split('T')[1].split('.')[0], // Time without milliseconds
    room: room,
    outcome: outcome
  };

  // If extra test data is available, add it to the outcome data
  if (testDocId && testTimestamp && leftLegStrength && rightLegStrength) {
    outcomeData['testId'] = testDocId;
    outcomeData['testTimestamp'] = testTimestamp;
    outcomeData['totalScore'] = parseInt(leftLegStrength) + parseInt(rightLegStrength);
  }

  // Using a Firestore transaction to handle database operations atomically
  return db.runTransaction((transaction) => {
    return transaction.get(db.collection('outcomes').where('room', '==', room).where('date', '==', outcomeData.date)).then((snapshot) => {
      if (!snapshot.empty) {
        snapshot.forEach((doc) => {
          transaction.update(doc.ref, outcomeData);
        });
      } else {
        transaction.set(db.collection('outcomes').doc(), outcomeData);
      }
    });
  }).then(() => {
    console.log("Transaction successfully committed!");
    populateOutcomesSection();
  }).catch((error) => {
    console.error("Transaction failed: ", error);
  });
}



// Updated deleteTest function
function deleteTest(testDocId, room) {  // Pass room as an argument
  db.collection('tests').doc(testDocId).delete().then(() => {
    // Do not delete outcomes here, just refresh the outcomes section
    populateOutcomesSection();  // Refresh outcomes section
  });
}



    populateOutcomesSection();

  </script>
</body>
</html>
